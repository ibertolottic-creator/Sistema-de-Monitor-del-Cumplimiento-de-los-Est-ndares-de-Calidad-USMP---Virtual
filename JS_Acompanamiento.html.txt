<!-- ==================== JS ACOMPAÑAMIENTO ==================== -->
<script>
  // 11 Criterios de Acompañamiento
  const CRITERIA_MAP_ACOMPANAMIENTO = [
    {id:'A_C01_OBJ', label:'1. Objetivos', dim:'Dimensión A', week:'ACOMPANAMIENTO', desc: 'Comunica el título del tema, de acuerdo con el sílabo, así como las competencias, capacidades y contenidos educativos que se desarrollarán durante la sesión, utilizando la plantilla institucional y reforzándolo mediante una explicación verbal.'},
    {id:'A_C02_SAB', label:'2. Saberes/ Motivación', dim:'Dimensión A', week:'ACOMPANAMIENTO', desc: 'Recupera los saberes previos de los estudiantes mediante diversas dinámicas pedagógicas y fomenta su interés y participación activa en la sesión, a través del uso de recursos educativos como noticias, videos, anécdotas, comentarios y herramientas digitales, entre otros.'},
    {id:'A_C03_CCO', label:'3. Conflicto Cognitivo', dim:'Dimensión A', week:'ACOMPANAMIENTO', desc: 'Plantea problemas teórico-prácticos relacionados con el contenido a desarrollarse, destacando su importancia, utilidad y aplicación en la vida personal y profesional del estudiante, con el fin de generar expectativas por el aprendizaje mediante preguntas y situaciones problemáticas contextualizadas.'},
    {id:'B_C04_CON', label:'4. Contenido', dim:'Dimensión B', week:'ACOMPANAMIENTO', desc: 'Desarrolla el contenido educativo programado en el sílabo siguiendo la secuencia didáctica; incorpora pausas activas para la resolución de actividades significativas de aprendizaje; y vincula la información abordada con experiencias y buenas prácticas de la vida real, considerando los aspectos éticos, la estimulación de la investigación formativa y el uso de referencias bibliográficas, cuando corresponda.'},
    {id:'B_C05_APL', label:'5. Aplicación', dim:'Dimensión B', week:'ACOMPANAMIENTO', desc: 'Realiza actividades aplicativas significativas de manera sincrónica y asincrónica, promoviendo la interacción de los estudiantes a través de diversas estrategias que favorezcan el aprendizaje contextualizado (trabajo en grupo, búsqueda de información, uso de organizadores de aprendizaje, simulaciones, juego de roles, talleres, debates, foros, wikis, videos, etc.)'},
    {id:'B_C06_EST', label:'6. Estrategias', dim:'Dimensión B', week:'ACOMPANAMIENTO', desc: 'Utiliza recursos interactivos pedagógicos que favorezcan la construcción del conocimiento de los estudiantes: exposiciones interactivas, aprendizaje colaborativo, problematización, estudio de casos, organizadores gráficos de aprendizaje (mapas, esquemas, flujogramas y otros), demostraciones, juegos, simulaciones, búsqueda y análisis de información de repositorios bibliográficos, plataformas web institucionales entre otros).'},
    {id:'B_C07_REC', label:'7. Recursos', dim:'Dimensión B', week:'ACOMPANAMIENTO', desc: 'Utiliza material audiovisual (videos, presentaciones, imágenes), plataformas en línea, software y aplicaciones, así como materiales impresos en físico o digitales (textos de lectura, fichas de actividades, diapositivas, material de laboratorio), uso de herramientas de IA, entre otros, para favorecer el interés de los estudiantes.'},
    {id:'B_C08_COM', label:'8. Comunic.', dim:'Dimensión B', week:'ACOMPANAMIENTO', desc: 'Promueve la interacción docente-estudiante en la relación pedagógica que asegure la transferencia del contenido educativo, la construcción de conocimientos y el cultivo de los valores institucionales a través del trabajo en equipo, en pares, uso de recursos visuales y audiovisuales (presentaciones ppt, videos, herramientas colaborativas TIC, plataformas de aprendizaje en línea), que faciliten la comprensión de los contenidos.'},
    {id:'B_C09_CAP', label:'9. Capac. Cognitivas', dim:'Dimensión B', week:'ACOMPANAMIENTO', desc: 'Orienta al estudiante a desarrollar las capacidades transversales cognoscitivas (conocimiento, comprensión, aplicación, análisis, síntesis, evaluación) e innovación, que le facilitan el aprender con sentido crítico, el desarrollo de capacidades para el logro de la competencia del perfil del graduado.'},
    {id:'C_C10_EVA', label:'10. Evaluac.', dim:'Dimensión C', week:'ACOMPANAMIENTO', desc: 'Aplica la metacognición y refuerza los temas críticos detectados, mediante diversas técnicas pedagógicas de reforzamiento y realimentación.'},
    {id:'C_C11_EXT', label:'11. Extensión', dim:'Dimensión C', week:'ACOMPANAMIENTO', desc: 'Orienta a los estudiantes sobre las tareas académicas encargadas para las siguientes sesiones y la investigación formativa a realizarse en las horas de trabajo independiente (HTI) fuera de aula, para fortalecer el aprendizaje autónomo.'}
  ];

  let currentAcompCourse = null;

  // Lógica Semáforo 31 Días
  function getAcompStats(startDateStr, grades) {
      if (!startDateStr) return { status: 'NO_INICIADO', progress: 0, color: 'ws-gray', daysElapsed: 0 };
      
      const start = parseDate(startDateStr);
      if (!start) return { status: 'NO_INICIADO', progress: 0, color: 'ws-gray', daysElapsed: 0 };
      
      const now = new Date();
      // Set to midnight for date comparisons
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const startDate = new Date(start.getFullYear(), start.getMonth(), start.getDate());
      
      const diffTime = Math.abs(today - startDate);
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Días transcurridos
      
      let filled = 0;
      let sumGrades = 0;
      CRITERIA_MAP_ACOMPANAMIENTO.forEach(i => { 
          if(grades && grades[i.id] > 0) {
              filled++; 
              sumGrades += parseFloat(grades[i.id]);
          }
      });
      const total = CRITERIA_MAP_ACOMPANAMIENTO.length; // 11
      const progress = Math.round((filled/total)*100);
      
      // Cálculo del Promedio Vigesimal (Base 20)
      // Escala 1 a 4. Promedio se calcula sobre la nota máxima posible de lo que ya fue evaluado.
      const maxScore = filled * 4;
      const avg20 = filled > 0 ? ((sumGrades / maxScore) * 20).toFixed(2) : "0.00";

      let color = 'ws-gray';
      let status = 'EN_PROCESO';

      if (progress === 100) {
          color = 'ws-green';
          status = 'COMPLETO';
      } else if (diffDays > 31) {
          color = 'ws-red';
          status = 'VENCIDO';
      } else {
          // Si no está completo ni vencido (días <= 31)
          if (progress === 0 && diffDays <= 21) {
              color = 'ws-gray'; // No iniciado y en fecha holgada
              status = 'NO_INICIADO';
          } else if (progress > 0 && diffDays <= 21) {
              color = 'ws-blue'; // Inició pero no terminó
          } else if (diffDays >= 22 && diffDays <= 28) {
              color = 'ws-yellow'; // Advertencia amarilla (haya iniciado o no)
          } else if (diffDays >= 29 && diffDays <= 31) {
              color = 'ws-orange'; // Advertencia naranja (haya iniciado o no)
          }
      }
      
      return { status: status, progress: progress, color: color, total: total, filled: filled, avg20: avg20, daysElapsed: diffDays };
  }

  function toggleViewAcomp(view) {
     const overview = document.getElementById('overview-panel-acomp');
     const detail = document.getElementById('detail-panel-acomp');
     
     if(view === 'OVERVIEW') {
        detail.classList.add('hidden');
        overview.classList.remove('hidden');
        renderOverviewAcomp();
     } else {
        overview.classList.add('hidden');
        detail.classList.remove('hidden');
     }
  }

  function renderOverviewAcomp() {
      const container = document.getElementById('overview-list-acomp');
      const listContainer = document.getElementById('course-list-acomp');
      const chartHeader = document.getElementById('dashboard-stats-header-acomp');
      container.innerHTML = '';
      listContainer.innerHTML = '';
      
      const term = document.getElementById('search-input-acomp').value.toLowerCase();
      
      const filtered = globalData.courses.filter(c => 
          String(c.courseName).toLowerCase().includes(term) || 
          String(c.professor).toLowerCase().includes(term) ||
          String(c.program).toLowerCase().includes(term)
      );

      document.getElementById('course-count-acomp').innerText = `${filtered.length} DOCENTES/ASIGNATURAS`;

      if(filtered.length === 0) {
          container.innerHTML = `<div class="p-8 text-center text-gray-400">No se encontraron resultados.</div>`;
          listContainer.innerHTML = `<div class="p-4 text-center text-xs text-gray-400">Sin resultados</div>`;
          return;
      }

      let countGreen = 0, countRed = 0, countGray = 0, countProcess = 0;

      filtered.forEach(c => {
          const stats = getAcompStats(c.startDate, c.grades);
          
          if(stats.color === 'ws-green') countGreen++;
          else if(stats.color === 'ws-red') countRed++;
          else if(stats.color === 'ws-gray') countGray++;
          else countProcess++; // Azul, Amarillo, Naranja

          // 1. Render Left Sidebar List
          const divLeft = document.createElement('div');
          divLeft.className = "p-4 cursor-pointer hover:bg-white transition-colors border-l-4 border-transparent hover:border-blue-500 group";
          divLeft.onclick = () => showCourseDetailAcomp(c.rowIndex);
          
          // Helper para bg color
          let bgStatusColor = 'bg-gray-100 text-gray-400';
          if(stats.color === 'ws-green') bgStatusColor = 'bg-green-100 text-green-600';
          if(stats.color === 'ws-red') bgStatusColor = 'bg-red-100 text-red-600';
          if(stats.color === 'ws-blue') bgStatusColor = 'bg-blue-100 text-blue-600';
          if(stats.color === 'ws-yellow') bgStatusColor = 'bg-yellow-100 text-yellow-600';
          if(stats.color === 'ws-orange') bgStatusColor = 'bg-orange-100 text-orange-600';

          divLeft.innerHTML = `
              <div class="flex justify-between items-start mb-1">
                  <span class="text-[10px] font-bold text-gray-400 uppercase tracking-wider">${c.program || 'N/A'}</span>
              </div>
              <h3 class="text-sm font-bold text-gray-800 leading-tight mb-2 group-hover:text-blue-600 transition-colors">${c.courseName}</h3>
              <p class="text-xs text-gray-500 mb-3"><i class="fa-regular fa-user mr-1"></i> ${c.professor}</p>
              
              <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                       <div class="w-8 h-8 rounded-full flex items-center justify-center ${bgStatusColor} font-bold text-xs ring-2 ring-white shadow-sm">
                           ${stats.progress}%
                       </div>
                  </div>
                  <span class="text-[10px] font-bold px-2 py-0.5 rounded-full ${bgStatusColor} bg-opacity-50">Día ${stats.daysElapsed}</span>
              </div>
          `;
          listContainer.appendChild(divLeft);

          // 2. Render Panel Central Cards
          let badgeStatus = '';
          if(stats.status === 'COMPLETO') badgeStatus = `<span class="bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold"><i class="fa-solid fa-check-circle mr-1"></i> COMPLETADO</span>`;
          else if(stats.status === 'VENCIDO') badgeStatus = `<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold"><i class="fa-solid fa-triangle-exclamation mr-1"></i> VENCIDO</span>`;
          else if(stats.status === 'NO_INICIADO') badgeStatus = `<span class="bg-gray-200 text-gray-600 px-2 py-1 rounded text-xs font-bold"><i class="fa-solid fa-clock mr-1"></i> NO INICIADO</span>`;
          else badgeStatus = `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold"><i class="fa-solid fa-spinner fa-spin mr-1"></i> EN PROCESO</span>`;

          const card = document.createElement('div');
          card.className = "bg-white p-5 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-all cursor-pointer group flex flex-col md:flex-row gap-5";
          card.onclick = () => showCourseDetailAcomp(c.rowIndex);
          
          card.innerHTML = `
             <div class="flex-1">
                 <div class="flex items-center justify-between mb-2">
                     <span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded uppercase tracking-wider">${c.program || 'Programa no def.'}</span>
                     ${badgeStatus}
                 </div>
                 <h3 class="text-lg font-bold text-gray-800 mb-1 group-hover:text-blue-600 transition-colors">${c.courseName}</h3>
                 <div class="text-sm text-gray-500 flex items-center gap-4">
                     <span><i class="fa-regular fa-user mr-1"></i> ${c.professor}</span>
                     <span><i class="fa-regular fa-calendar-alt mr-1"></i> Día ${stats.daysElapsed}</span>
                 </div>
             </div>
             
             <div class="flex flex-col items-center justify-center border-t md:border-t-0 md:border-l border-gray-100 pt-4 md:pt-0 md:pl-6 min-w-[120px]">
                 <div class="text-xs text-gray-400 font-bold mb-1 uppercase tracking-wider text-center">Avance</div>
                 <div class="w-14 h-14 rounded-full flex items-center justify-center ${bgStatusColor} font-black text-lg ring-4 ring-white shadow-sm mb-2">
                     ${stats.progress}%
                 </div>
                 <div class="text-xs font-bold text-indigo-500">Promedio: ${stats.avg20}</div>
             </div>
          `;
          container.appendChild(card);
      });

      // KPI Dashboard Header Acompañamiento
      chartHeader.innerHTML = `
          <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
              <div><p class="text-[10px] text-gray-400 font-bold uppercase">Completados</p><h3 class="text-xl font-black text-green-600">${countGreen}</h3></div>
              <div class="w-8 h-8 rounded-full bg-green-50 text-green-500 flex items-center justify-center"><i class="fa-solid fa-check"></i></div>
          </div>
          <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
              <div><p class="text-[10px] text-gray-400 font-bold uppercase">En Proceso</p><h3 class="text-xl font-black text-blue-600">${countProcess}</h3></div>
              <div class="w-8 h-8 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-play"></i></div>
          </div>
          <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
              <div><p class="text-[10px] text-gray-400 font-bold uppercase">Sin iniciar</p><h3 class="text-xl font-black text-gray-600">${countGray}</h3></div>
              <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center"><i class="fa-solid fa-pause"></i></div>
          </div>
          <div class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm flex items-center justify-between">
              <div><p class="text-[10px] text-gray-400 font-bold uppercase">Vencidos</p><h3 class="text-xl font-black text-red-600">${countRed}</h3></div>
              <div class="w-8 h-8 rounded-full bg-red-50 text-red-500 flex items-center justify-center"><i class="fa-solid fa-triangle-exclamation"></i></div>
          </div>
      `;
  }

  function showCourseDetailAcomp(rowIndex) {
      currentAcompCourse = globalData.courses.find(c => c.rowIndex === rowIndex);
      if(!currentAcompCourse) return;

      document.getElementById('detail-course-name-acomp').innerText = currentAcompCourse.courseName;
      document.getElementById('detail-professor-acomp').innerText = currentAcompCourse.professor;
      document.getElementById('detail-program-acomp').innerText = currentAcompCourse.program || 'N/A';
      document.getElementById('detail-students-acomp').innerText = `${currentAcompCourse.studentsCount} Alumnos`;
      
      let dateText = "No definida";
      if(currentAcompCourse.startDate) {
         const d = parseDate(currentAcompCourse.startDate);
         if(d) dateText = d.toLocaleDateString('es-PE', {day:'2-digit', month:'short', year:'numeric'});
      }
      document.getElementById('detail-start-date-acomp').innerText = dateText;

      // Links Aulas
      const ap = currentAcompCourse.links.AP.url;
      const usmp = currentAcompCourse.links.USMP.url;
      document.getElementById('link-ap-acomp').href = ap || '#';
      if(!ap) document.getElementById('link-ap-acomp').classList.add('opacity-50', 'pointer-events-none');
      else document.getElementById('link-ap-acomp').classList.remove('opacity-50', 'pointer-events-none');
      
      document.getElementById('link-usmp-acomp').href = usmp || '#';
      if(!usmp) document.getElementById('link-usmp-acomp').classList.add('opacity-50', 'pointer-events-none');
      else document.getElementById('link-usmp-acomp').classList.remove('opacity-50', 'pointer-events-none');

      renderDetailAcomp();
      toggleViewAcomp('DETAIL');
  }

  function renderDetailAcomp() {
      const stats = getAcompStats(currentAcompCourse.startDate, currentAcompCourse.grades);
      
      // Update Progress Bar y Promedio Vigesimal
      document.getElementById('acomp-progress-bar').style.width = `${stats.progress}%`;
      document.getElementById('acomp-avg-display').innerText = stats.avg20;
      
      // Color bar logic
      const pBar = document.getElementById('acomp-progress-bar');
      pBar.className = "h-2 rounded-full transition-all duration-500";
      if(stats.color === 'ws-green') pBar.classList.add('bg-green-500');
      else if(stats.color === 'ws-red') pBar.classList.add('bg-red-500');
      else if(stats.color === 'ws-yellow') pBar.classList.add('bg-yellow-400');
      else if(stats.color === 'ws-orange') pBar.classList.add('bg-orange-500');
      else if(stats.color === 'ws-blue') pBar.classList.add('bg-blue-500');
      else pBar.classList.add('bg-gray-400');

      updateActionButtonsAcomp(stats);

      // Update Deadline Info
      const dlInfo = document.getElementById('acomp-deadline-info');
      if (stats.status === 'VENCIDO') {
          dlInfo.innerHTML = `<span class="text-red-600"><i class="fa-solid fa-calendar-xmark mr-2"></i> Plazo Vencido (Día ${stats.daysElapsed})</span>`;
      } else if (stats.status === 'COMPLETO') {
          dlInfo.innerHTML = `<span class="text-green-600"><i class="fa-solid fa-check-circle mr-2"></i> Completado Exitosamente</span>`;
      } else {
          let warnColor = "text-gray-500";
          if (stats.color === 'ws-yellow') warnColor = "text-yellow-600";
          if (stats.color === 'ws-orange') warnColor = "text-orange-600";
          const remaining = 31 - stats.daysElapsed;
          dlInfo.innerHTML = `<span class="${warnColor}"><i class="fa-regular fa-clock mr-2"></i> Quedan ${remaining} días (Día ${stats.daysElapsed})</span>`;
      }

      // Render Criterios
      const container = document.getElementById('criteria-container-acomp');
      container.innerHTML = '';
      
      const isGuest = window.AUTH_DATA && window.AUTH_DATA.isGuest;
      const isLocked = (stats.status === 'VENCIDO');

      CRITERIA_MAP_ACOMPANAMIENTO.forEach(item => {
          let currentVal = currentAcompCourse.grades[item.id] || '';
          let tsText = currentAcompCourse.timestamps[item.id] || '';
          if (tsText) {
             const d = new Date(tsText);
             if(!isNaN(d.getTime())) tsText = d.toLocaleString('es-PE', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
          }

          let selectHTML = '';
          if (isGuest || (isLocked && !currentVal)) {
             // Si es invitado, o si está bloqueado (vencido) y no se llenó, se muestra como bloqueado. 
             // Si está vencido pero ya tiene un valor, igual lo mostramos pero disabled para evitar cambios.
             let badge = `<span class="px-3 py-1 bg-gray-100 text-gray-400 rounded font-bold text-sm text-center block">Sin Evaluar ${isLocked && !isGuest ? '<br/><span class="text-[9px] text-red-500 uppercase">(Fuera de plazo)</span>' : ''}</span>`;
             if(currentVal == 1) badge = `<span class="px-3 py-1 bg-red-100 text-red-700 rounded font-bold text-sm block">1 - Deficiente ${isLocked && !isGuest ? '<span class="text-[9px] block text-red-500 uppercase">Bloqueado</span>' : ''}</span>`;
             if(currentVal == 2) badge = `<span class="px-3 py-1 bg-red-50 text-red-600 rounded font-bold text-sm block">2 - Regular ${isLocked && !isGuest ? '<span class="text-[9px] block text-red-500 uppercase">Bloqueado</span>' : ''}</span>`;
             if(currentVal == 3) badge = `<span class="px-3 py-1 bg-green-50 text-green-600 rounded font-bold text-sm block">3 - Bueno ${isLocked && !isGuest ? '<span class="text-[9px] block text-green-700 uppercase">Bloqueado</span>' : ''}</span>`;
             if(currentVal == 4) badge = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded font-bold text-sm block">4 - Muy Bueno ${isLocked && !isGuest ? '<span class="text-[9px] block text-green-700 uppercase">Bloqueado</span>' : ''}</span>`;
             selectHTML = badge;
          } else if (isLocked && currentVal) {
             // Si ya pasó el plazo pero TIENE valor ingresado, mostramos el badge inamovible
             let badge = `<span class="px-3 py-1 bg-gray-100 text-gray-500 rounded font-bold text-sm text-center block">Cargando...</span>`;
             if(currentVal == 1) badge = `<span class="px-3 py-1 bg-red-100 text-red-700 rounded font-bold text-sm block text-center">1 - Deficiente <span class="text-[9px] block text-red-500 uppercase mt-1">Cerrado</span></span>`;
             if(currentVal == 2) badge = `<span class="px-3 py-1 bg-red-50 text-red-600 rounded font-bold text-sm block text-center">2 - Regular <span class="text-[9px] block text-red-500 uppercase mt-1">Cerrado</span></span>`;
             if(currentVal == 3) badge = `<span class="px-3 py-1 bg-green-50 text-green-600 rounded font-bold text-sm block text-center">3 - Bueno <span class="text-[9px] block text-green-700 uppercase mt-1">Cerrado</span></span>`;
             if(currentVal == 4) badge = `<span class="px-3 py-1 bg-green-100 text-green-700 rounded font-bold text-sm block text-center">4 - Muy Bueno <span class="text-[9px] block text-green-700 uppercase mt-1">Cerrado</span></span>`;
             selectHTML = badge;
          } else {
             // Editable (En plazo valido y no es Guest)
             selectHTML = `
                <select id="grid_${item.id}" class="criteria-select w-36 border border-gray-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none font-bold text-center appearance-none cursor-pointer hover:shadow-sm" onchange="saveCriterionAcomp('${item.id}', this.value)">
                    <option value="" ${!currentVal ? 'selected' : ''}>- Evaluar -</option>
                    <option value="1" ${currentVal == 1 ? 'selected' : ''} class="text-red-700 bg-red-50">1 - Deficiente</option>
                    <option value="2" ${currentVal == 2 ? 'selected' : ''} class="text-red-600 bg-red-50">2 - Regular</option>
                    <option value="3" ${currentVal == 3 ? 'selected' : ''} class="text-green-600 bg-green-50">3 - Bueno</option>
                    <option value="4" ${currentVal == 4 ? 'selected' : ''} class="text-green-700 bg-green-50">4 - Muy Bueno</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-1.5 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
             `;
          }

          let dimColorClass = 'text-blue-500';
          let dimBgClass = 'bg-blue-50';
          if(item.dim === 'Dimensión B') { dimColorClass = 'text-purple-500'; dimBgClass = 'bg-purple-50'; }
          if(item.dim === 'Dimensión C') { dimColorClass = 'text-teal-600'; dimBgClass = 'bg-teal-50'; }

          const row = document.createElement('div');
          row.className = "bg-white p-5 rounded-2xl border border-gray-100 flex flex-col md:flex-row md:items-start justify-between gap-4 shadow-sm hover:shadow-md transition-shadow mb-4";
          
          row.innerHTML = `
              <div class="flex-1 w-full max-w-2xl">
                 <div class="flex items-center flex-wrap gap-2 mb-2">
                    <span class="text-[10px] font-bold ${dimColorClass} ${dimBgClass} border border-opacity-20 px-2 py-0.5 rounded uppercase tracking-widest">${item.dim}</span>
                    ${tsText ? `<span class="text-[10px] text-gray-500 font-medium bg-gray-50 px-2 py-0.5 rounded border border-gray-200" id="ts_${item.id}"><i class="fa-regular fa-clock"></i> Eval: ${tsText}</span>` : `<span class="text-[10px] text-gray-400 font-medium hidden" id="ts_${item.id}"></span>`}
                 </div>
                 <h4 class="font-bold text-gray-800 text-[15px] mb-1">${item.label}</h4>
                 <p class="text-xs text-gray-500 leading-relaxed font-medium mt-1 pr-4">${item.desc}</p>
              </div>
              <div class="relative w-max mt-2 md:mt-0 self-start md:self-center">
                 ${selectHTML}
              </div>
          `;
          container.appendChild(row);
          if(!isGuest && !isLocked) updateSelectColorAcomp(document.getElementById(`grid_${item.id}`));
      });
  }

  function updateSelectColorAcomp(el) {
      if(!el) return;
      el.classList.remove('bg-white', 'bg-red-50', 'bg-green-50', 'text-red-700', 'text-green-700', 'border-red-300', 'border-green-300', 'text-gray-700');
      const v = el.value;
      if (v == 1 || v == 2) el.classList.add('bg-red-50', 'text-red-700', 'border-red-300');
      else if (v == 3 || v == 4) el.classList.add('bg-green-50', 'text-green-700', 'border-green-300');
      else el.classList.add('bg-white', 'text-gray-700');
  }

  function saveCriterionAcomp(criteriaId, value) {
      if (window.AUTH_DATA && window.AUTH_DATA.isGuest) {
          alert("Acceso Limitado. Modo lectura.");
          return;
      }
      
      const sel = document.getElementById(`grid_${criteriaId}`);
      updateSelectColorAcomp(sel);

      // Bloqueo temporal de UI
      sel.disabled = true;
      sel.classList.add('opacity-50', 'cursor-wait');

      showSavingToastAcomp();

      google.script.run
      .withSuccessHandler(res => {
          sel.disabled = false;
          sel.classList.remove('opacity-50', 'cursor-wait');

          if (res && res.maintenance) {
              hideSavingToastAcomp();
              alert("Sistema en mantenimiento. Su cambio no ha sido guardado.");
              setTimeout(() => { window.location.reload(); }, 1000);
              return;
          }
          if (res && res.success) {
              showSuccessToastAcomp();
              // Update Cache
              if(!currentAcompCourse.grades) currentAcompCourse.grades = {};
              if(!currentAcompCourse.timestamps) currentAcompCourse.timestamps = {};
              currentAcompCourse.grades[criteriaId] = value;
              currentAcompCourse.timestamps[criteriaId] = res.timestamp;
              
              // Update UI Timestamp
              const tsEl = document.getElementById(`ts_${criteriaId}`);
              if (tsEl) {
                 const d = new Date(res.timestamp);
                 tsEl.innerHTML = `<i class="fa-regular fa-clock"></i> ${d.toLocaleString('es-PE', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'})}`;
                 tsEl.classList.remove('hidden');
                 tsEl.classList.add('bg-green-50', 'border-green-200', 'text-green-700', 'px-2', 'py-0.5', 'rounded', 'border');
              }

              // Update Global Progreso (Re-render params)
              renderDetailAcomp();
          } else {
             hideSavingToastAcomp();
             alert("Error guardando: " + res.message);
          }
      })
      .withFailureHandler(e => {
          sel.disabled = false;
          sel.classList.remove('opacity-50', 'cursor-wait');
          hideSavingToastAcomp();
          alert("Error de Conexión: " + e);
      })
      .saveGrade(currentAcompCourse.rowIndex, criteriaId, value, 'ACOMPANAMIENTO', 'ACOMPANAMIENTO');
  }

  function updateActionButtonsAcomp(stats) {
      const btnCongratulate = document.getElementById('btn-congratulate-acomp');
      const btnReport = document.getElementById('btn-report-acomp');
      if (!btnCongratulate || !btnReport) return;

      // Felicitar: solo cuando promedio es 20.00 exacto
      if (stats && stats.avg20 === "20.00" && stats.filled > 0) {
          btnCongratulate.classList.remove('hidden');
      } else {
          btnCongratulate.classList.add('hidden');
      }

      // Reportar: solo cuando hay un 1 o 2
      let hasDeficient = false;
      if (currentAcompCourse && currentAcompCourse.grades) {
          for (let key in currentAcompCourse.grades) {
              const val = parseInt(currentAcompCourse.grades[key]);
              if (val === 1 || val === 2) {
                  hasDeficient = true;
                  break;
              }
          }
      }

      if (hasDeficient) {
          btnReport.classList.remove('hidden');
      } else {
          btnReport.classList.add('hidden');
      }
  }

  function trackAcompClick(type) {
      if(!currentAcompCourse) return;
      google.script.run.trackAccess(currentAcompCourse.rowIndex, type, 'ACOMPANAMIENTO');
  }

  // --- Toasts específicos para Acompañamiento ---
  function showSavingToastAcomp() {
      const toast = document.getElementById('save-indicator');
      toast.innerHTML = `<div class="bg-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 animate-scale-in text-gray-800 border border-gray-100">
           <i class="fa-solid fa-circle-notch fa-spin text-2xl text-blue-500"></i>
           <div>
              <p class="font-bold">Guardando...</p>
              <p class="text-xs text-gray-500">Actualizando registro en tiempo real</p>
           </div>
        </div>`;
      toast.classList.remove('hidden');
  }

  function showSuccessToastAcomp() {
      const toast = document.getElementById('save-indicator');
      toast.innerHTML = `<div class="bg-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-4 animate-scale-in text-gray-800 border border-gray-100">
           <i class="fa-solid fa-check-circle text-2xl text-green-500"></i>
           <div>
              <p class="font-bold">¡Guardado Exitoso!</p>
              <p class="text-xs text-gray-500">Sincronizado con Google Sheets</p>
           </div>
        </div>`;
      setTimeout(() => { toast.classList.add('hidden'); }, 1500);
  }

  function hideSavingToastAcomp() {
      document.getElementById('save-indicator').classList.add('hidden');
  }

  // --- Botón de Retorno Home ---
  function goHomeFromAcomp() {
     document.getElementById('module-acomp').classList.add('hidden');
     document.getElementById('module-acomp').style.display='none';
     document.getElementById('home-view').classList.remove('hidden');
     globalData=null; currentAcompCourse=null;
  }

  // --- Manejo de Correos ---
  function openEmailModalAcomp(t) {
      if(window.AUTH_DATA && window.AUTH_DATA.isGuest) {
          alert("Acceso Limitado. Modo lectura.");
          return;
      }
      
      // Pasar las variables locales de Acompañamiento a las variables globales del Modal
      currentCourse = currentAcompCourse;
      currentWeekId = 'ACOMPANAMIENTO';
      
      if (typeof openEmailModal === 'function') {
          openEmailModal(t);
      }
  }
</script>
