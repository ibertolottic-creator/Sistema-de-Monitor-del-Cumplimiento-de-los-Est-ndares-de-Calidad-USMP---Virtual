<script>
    /**
     * JS_Templates.html
     * Maneja la generación de correos dinámicos para Virtual y Presencial.
     */

    function getTemplate(type, course, week) {
        if (!course) return { subject: '', body: '' }; // Fallback de seguridad
        const professorStr = String(course.professor || 'Docente');
        const profName = professorStr.split(' ')[0]; // Primer nombre
        const weekNum = (week || '').replace('S', '');

        // Helper para título propio (Title Case)
        const toTitleCase = (str) => {
            return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
        };

        let gradoRaw = 'Coordinación Académica';
        const ssName = window.SS_NAME || '';
        if (ssName.includes("PREGRADO")) gradoRaw = 'Pregrado';
        else if (ssName.includes("POSGRADO")) gradoRaw = 'Posgrado';
        else gradoRaw = course.program || course.grade || 'Coordinación Académica';

        const grado = toTitleCase(String(gradoRaw));

        if (week === 'ACOMPANAMIENTO') {
            if (type === 'CONGRATULATE') {
                return {
                    subject: `Reconocimiento por desempeño sobresaliente en su sesión de clase - ${course.courseName}`,
                    body: `Estimado/a Docente ${course.professor}:<br><br>` +
                        `Por medio de la presente, nos dirigimos a usted en el marco del Acompañamiento del Desempeño Pedagógico para expresarle nuestro reconocimiento por el excelente desarrollo de su sesión de clase correspondiente a la asignatura <b>${course.courseName}</b>.<br><br>` +
                        `Tras la evaluación realizada, destacamos que ha cumplido de manera sobresaliente con todos los criterios y estándares de calidad establecidos. Su excelente labor pedagógica es fundamental para salvaguardar la calidad de enseñanza de nuestra casa de estudios.<br><br>` +
                        `Le animamos a mantener este alto nivel de compromiso y profesionalismo, el cual impacta directamente en el éxito formativo de nuestros estudiantes.<br><br>` +
                        `Atentamente,<br><br>` +
                        `<b>Área de ${grado} USMP Virtual</b>`
                };
            } else if (type === 'REPORT') {
                const labels = {
                    'A_C01_OBJ': '1. Objetivos', 'A_C02_SAB': '2. Saberes/ Motivación', 'A_C03_CCO': '3. Conflicto Cognitivo',
                    'B_C04_CON': '4. Contenido', 'B_C05_APL': '5. Aplicación', 'B_C06_EST': '6. Estrategias',
                    'B_C07_REC': '7. Recursos', 'B_C08_COM': '8. Comunic.', 'B_C09_CAP': '9. Capac. Cognitivas',
                    'C_C10_EVA': '10. Evaluac.', 'C_C11_EXT': '11. Extensión'
                };

                let pendingStr = '';
                if (course && course.grades) {
                    for (let key in labels) {
                        const val = parseInt(course.grades[key] || 0);
                        if (val === 1 || val === 2) {
                            pendingStr += `<li>${labels[key]}</li>`;
                        }
                    }
                }

                return {
                    subject: `Observaciones en el Acompañamiento del Desempeño Pedagógico de su sesión de clase - ${course.courseName}`,
                    body: `Estimado/a Docente ${course.professor}:<br><br>` +
                        `Por medio de la presente, nos dirigimos a usted en el marco del Acompañamiento del Desempeño Pedagógico para comunicarle los resultados de la evaluación del desarrollo de su sesión de clase, correspondiente a la asignatura <b>${course.courseName}</b>.<br><br>` +
                        `Tras la revisión, se ha detectado el incumplimiento de los criterios pedagógicos de calidad establecidos para el correcto desarrollo de las sesiones de clase. A continuación, detallamos los aspectos deficientes y que requieren mejora inmediata:<br><br>` +
                        `<ul>${pendingStr || '<li>Sin observaciones registradas</li>'}</ul><br>` +
                        `La USMP Virtual está firmemente comprometida con brindar un servicio educativo de calidad y excelencia a sus estudiantes. Por ello, esperamos que pueda comprometerse a implementar las mejoras señaladas y a cumplir rigurosamente con los estándares institucionales establecidos en sus próximas sesiones.<br><br>` +
                        `Agradecemos su atención y pronta disposición.<br><br>` +
                        `Atentamente,<br><br>` +
                        `<b>Área de ${grado} USMP Virtual</b>`
                };
            }
            return { subject: '', body: '' };
        }

        if (type === 'CONGRATULATE') {
            return {
                subject: `Mención de desempeño destacado y cumplimiento de estándares - ${course.courseName}. Semana ${weekNum}`,
                body: `Estimado/a Docente ${course.professor}:<br><br>` +
                    `Mediante la presente, brindamos el reconocimiento debido por la labor docente realizada durante la semana <b>${weekNum}</b> en la asignatura <b>${course.courseName}</b>.<br><br>` +
                    `Tras la revisión de los indicadores de desempeño, nos complace validar que su gestión ha cumplido satisfactoriamente con los estándares académicos establecidos. Su rigor y compromiso son vitales para garantizar la excelencia en la calidad del servicio educativo que ofrecemos.<br><br>` +
                    `Le exhortamos a mantener esta línea de trabajo, consolidando así el prestigio de nuestra institución y el aprendizaje de los estudiantes.<br><br>` +
                    `Atentamente,<br><br>` +
                    `<b>Área de ${grado}</b><br>` +
                    `<b>USMP Virtual.</b>`
            };
        } else if (type === 'REPORT') {
            // Identificar pendientes (calificaciones 1 o 2)
            // Usa CURRENT_CRITERIA_MAP definido en JS_Client.html
            const pending = CURRENT_CRITERIA_MAP
                .filter(x => {
                    if (x.week !== week) return false;
                    const val = parseInt(course.grades[x.id] || 0);
                    return (val === 1 || val === 2);
                })
                .map(x => `<li>${x.label}</li>`)
                .join('');

            return {
                subject: `Notificación de Incumplimiento o cumplimiento parcial de sus funciones como docente - USMP Virtual`,
                body: `Estimado/a ${course.professor}:<br><br>` +
                    `Por medio de la presente, le comunicamos los resultados de la supervisión realizada a su desempeño docente durante la semana <b>${weekNum}</b> en la asignatura <b>${course.courseName}</b>.<br><br>` +
                    `Y le informamos que se ha detectado el incumplimiento de los criterios de calidad establecidos por la normativa de nuestra casa de estudios.<br><br>` +
                    `<ul>${pending || '<li>Sin observaciones registradas</li>'}</ul><br>` +
                    `Esta situación afecta directamente el desarrollo del servicio educativo y contraviene las disposiciones académicas vigentes.<br><br>` +
                    `Le instamos a subsanar las observaciones detectadas de manera inmediata y a alinear estrictamente su gestión con los estándares institucionales.<br><br>` +
                    `Quedamos a la espera de su pronta regularización.<br><br>` +
                    `Atentamente,<br><br>` +
                    `<b>Área de ${grado}</b><br>` +
                    `<b>USMP Virtual</b>`
            };
        }
        return { subject: '', body: '' };
    }
</script>